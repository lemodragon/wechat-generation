<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼“å­˜åŠŸèƒ½æµ‹è¯• - å¾®ä¿¡å¯¹è¯ç”Ÿæˆå™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .test-section h2::before {
            content: "ğŸ”¬";
            margin-right: 10px;
            font-size: 1.8rem;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .test-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .test-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .test-item h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn.success {
            background: #28a745;
        }

        .btn.success:hover {
            background: #218838;
        }

        .btn.warning {
            background: #ffc107;
            color: #212529;
        }

        .btn.warning:hover {
            background: #e0a800;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        .status-display {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #6c757d;
        }

        .status-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .status-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #4a5568;
        }

        .log-timestamp {
            color: #a0aec0;
            margin-right: 10px;
        }

        .log-level {
            margin-right: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .log-info {
            background: #3182ce;
        }

        .log-success {
            background: #38a169;
        }

        .log-warning {
            background: #d69e2e;
        }

        .log-error {
            background: #e53e3e;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #007bff, #28a745);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .test-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid transparent;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .test-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ ç¼“å­˜åŠŸèƒ½æµ‹è¯•</h1>
            <p>å¾®ä¿¡å¯¹è¯ç”Ÿæˆå™¨ - ç¼“å­˜ç®¡ç†ç³»ç»Ÿæµ‹è¯•å·¥å…·</p>
        </div>

        <div class="content">
            <div class="alert alert-info">
                <strong>ğŸ“‹ æµ‹è¯•è¯´æ˜ï¼š</strong>æœ¬é¡µé¢æä¾›äº†å®Œæ•´çš„ç¼“å­˜åŠŸèƒ½æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥éªŒè¯æ‰€æœ‰ç¼“å­˜ç›¸å…³åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
            </div>

            <!-- ç³»ç»ŸçŠ¶æ€æ£€æµ‹ -->
            <div class="test-section">
                <h2>ç³»ç»ŸçŠ¶æ€æ£€æµ‹</h2>
                <div class="test-grid">
                    <div class="test-item">
                        <h3>æµè§ˆå™¨å…¼å®¹æ€§</h3>
                        <div id="browser-status" class="status-display">æ£€æµ‹ä¸­...</div>
                        <button class="btn" onclick="checkBrowserSupport()">é‡æ–°æ£€æµ‹</button>
                    </div>
                    <div class="test-item">
                        <h3>localStorage å¯ç”¨æ€§</h3>
                        <div id="storage-status" class="status-display">æ£€æµ‹ä¸­...</div>
                        <button class="btn" onclick="checkStorageSupport()">é‡æ–°æ£€æµ‹</button>
                    </div>
                    <div class="test-item">
                        <h3>ç¼“å­˜ç®¡ç†å™¨çŠ¶æ€</h3>
                        <div id="cache-manager-status" class="status-display">æ£€æµ‹ä¸­...</div>
                        <button class="btn" onclick="checkCacheManager()">é‡æ–°æ£€æµ‹</button>
                    </div>
                </div>
            </div>

            <!-- åŸºç¡€åŠŸèƒ½æµ‹è¯• -->
            <div class="test-section">
                <h2>åŸºç¡€åŠŸèƒ½æµ‹è¯•</h2>
                <div class="test-grid">
                    <div class="test-item">
                        <h3>æ•°æ®ä¿å­˜æµ‹è¯•</h3>
                        <button class="btn success" onclick="testDataSave()">æµ‹è¯•ä¿å­˜åŠŸèƒ½</button>
                        <button class="btn" onclick="testDataLoad()">æµ‹è¯•åŠ è½½åŠŸèƒ½</button>
                        <div id="save-load-result" class="status-display">ç­‰å¾…æµ‹è¯•...</div>
                    </div>
                    <div class="test-item">
                        <h3>å¤‡ä»½åŠŸèƒ½æµ‹è¯•</h3>
                        <button class="btn" onclick="testBackupCreate()">åˆ›å»ºæµ‹è¯•å¤‡ä»½</button>
                        <button class="btn warning" onclick="testBackupRestore()">æ¢å¤æœ€æ–°å¤‡ä»½</button>
                        <div id="backup-result" class="status-display">ç­‰å¾…æµ‹è¯•...</div>
                    </div>
                    <div class="test-item">
                        <h3>å¯¼å‡ºå¯¼å…¥æµ‹è¯•</h3>
                        <button class="btn" onclick="testDataExport()">æµ‹è¯•æ•°æ®å¯¼å‡º</button>
                        <div class="file-input-wrapper">
                            <button class="btn">æµ‹è¯•æ•°æ®å¯¼å…¥</button>
                            <input type="file" accept=".json" onchange="testDataImport(this)">
                        </div>
                        <div id="export-import-result" class="status-display">ç­‰å¾…æµ‹è¯•...</div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ‹Ÿåœºæ™¯æµ‹è¯• -->
            <div class="test-section">
                <h2>æ¨¡æ‹Ÿåœºæ™¯æµ‹è¯•</h2>
                <div class="test-grid">
                    <div class="test-item">
                        <h3>å¼‚å¸¸é€€å‡ºæ¨¡æ‹Ÿ</h3>
                        <button class="btn warning" onclick="simulateAbnormalExit()">æ¨¡æ‹Ÿå¼‚å¸¸é€€å‡º</button>
                        <button class="btn" onclick="simulateNormalExit()">æ¨¡æ‹Ÿæ­£å¸¸é€€å‡º</button>
                        <div id="exit-simulation-result" class="status-display">ç­‰å¾…æµ‹è¯•...</div>
                    </div>
                    <div class="test-item">
                        <h3>å¤§é‡æ•°æ®æµ‹è¯•</h3>
                        <button class="btn" onclick="generateLargeDataset()">ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ®</button>
                        <button class="btn danger" onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
                        <div id="large-data-result" class="status-display">ç­‰å¾…æµ‹è¯•...</div>
                    </div>
                    <div class="test-item">
                        <h3>æ€§èƒ½å‹åŠ›æµ‹è¯•</h3>
                        <button class="btn" onclick="startPerformanceTest()">å¼€å§‹æ€§èƒ½æµ‹è¯•</button>
                        <button class="btn danger" onclick="stopPerformanceTest()">åœæ­¢æµ‹è¯•</button>
                        <div class="progress-bar">
                            <div id="performance-progress" class="progress-fill"></div>
                        </div>
                        <div id="performance-result" class="status-display">ç­‰å¾…æµ‹è¯•...</div>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="test-section">
                <h2>å®æ—¶ç»Ÿè®¡ä¿¡æ¯</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div id="stat-storage-used" class="stat-value">0 KB</div>
                        <div class="stat-label">å­˜å‚¨ä½¿ç”¨é‡</div>
                    </div>
                    <div class="stat-item">
                        <div id="stat-keys-count" class="stat-value">0</div>
                        <div class="stat-label">ç¼“å­˜é”®æ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div id="stat-backup-count" class="stat-value">0</div>
                        <div class="stat-label">å¤‡ä»½æ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div id="stat-last-save" class="stat-value">æœªçŸ¥</div>
                        <div class="stat-label">æœ€åä¿å­˜</div>
                    </div>
                </div>
                <div class="test-controls">
                    <button class="btn" onclick="updateStats()">åˆ·æ–°ç»Ÿè®¡</button>
                    <button class="btn" onclick="exportTestReport()">å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š</button>
                    <button class="btn danger" onclick="clearAllTestData()">æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®</button>
                </div>
            </div>

            <!-- æµ‹è¯•æ—¥å¿— -->
            <div class="test-section">
                <h2>æµ‹è¯•æ—¥å¿—</h2>
                <div class="test-controls">
                    <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                    <button class="btn" onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
                    <button class="btn" onclick="toggleAutoScroll()">åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨</button>
                </div>
                <div id="log-container" class="log-container">
                    <!-- æ—¥å¿—å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>

            <!-- æ“ä½œæŒ‡å— -->
            <div class="alert alert-warning">
                <strong>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</strong>
                <ul style="margin: 10px 0 0 20px;">
                    <li>æœ¬æµ‹è¯•é¡µé¢ä¼šåˆ›å»ºä¸´æ—¶æµ‹è¯•æ•°æ®ï¼Œæµ‹è¯•å®Œæˆåå»ºè®®æ¸…ç†</li>
                    <li>æ€§èƒ½æµ‹è¯•å¯èƒ½ä¼šå ç”¨è¾ƒå¤šç³»ç»Ÿèµ„æºï¼Œè¯·è°¨æ…ä½¿ç”¨</li>
                    <li>å¼‚å¸¸é€€å‡ºæ¨¡æ‹Ÿä»…æ¨¡æ‹Ÿæ ‡è®°çŠ¶æ€ï¼Œä¸ä¼šçœŸæ­£å…³é—­æµè§ˆå™¨</li>
                    <li>å¤§é‡æ•°æ®æµ‹è¯•å¯èƒ½æ¥è¿‘localStorageå­˜å‚¨é™åˆ¶</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ç¼“å­˜ç®¡ç†å™¨è„šæœ¬ -->
    <script src="static/app/js/cache-manager.js"></script>

    <script>
        // æµ‹è¯•è„šæœ¬
        let testLog = [];
        let performanceTestInterval = null;
        let autoScroll = true;

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                level,
                message
            };
            testLog.push(logEntry);

            const logContainer = document.getElementById('log-container');
            const logElement = document.createElement('div');
            logElement.className = 'log-entry';
            logElement.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-level log-${level}">${level.toUpperCase()}</span>
                ${message}
            `;
            logContainer.appendChild(logElement);

            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            if (testLog.length > 1000) {
                testLog.shift();
                if (logContainer.children.length > 1000) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
        }

        // æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹
        function checkBrowserSupport() {
            const statusElement = document.getElementById('browser-status');
            const browser = getBrowserInfo();

            if (browser.isSupported) {
                statusElement.className = 'status-display status-success';
                statusElement.textContent = `âœ… ${browser.name} ${browser.version} - å®Œå…¨æ”¯æŒ`;
                addLog(`æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹: ${browser.name} ${browser.version} - æ”¯æŒæ‰€æœ‰åŠŸèƒ½`, 'success');
            } else {
                statusElement.className = 'status-display status-error';
                statusElement.textContent = `âŒ ${browser.name} - ä¸å®Œå…¨æ”¯æŒ`;
                addLog(`æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹: ${browser.name} - ç¼ºå°‘å¿…è¦åŠŸèƒ½`, 'error');
            }
        }

        // localStorageæ”¯æŒæ£€æµ‹
        function checkStorageSupport() {
            const statusElement = document.getElementById('storage-status');

            try {
                localStorage.setItem('test_cache_support', 'test');
                localStorage.removeItem('test_cache_support');
                statusElement.className = 'status-display status-success';
                statusElement.textContent = 'âœ… localStorage å®Œå…¨å¯ç”¨';
                addLog('localStorageæ”¯æŒæ£€æµ‹: å®Œå…¨å¯ç”¨', 'success');
            } catch (error) {
                statusElement.className = 'status-display status-error';
                statusElement.textContent = `âŒ localStorage ä¸å¯ç”¨: ${error.message}`;
                addLog(`localStorageæ”¯æŒæ£€æµ‹: ä¸å¯ç”¨ - ${error.message}`, 'error');
            }
        }

        // ç¼“å­˜ç®¡ç†å™¨çŠ¶æ€æ£€æµ‹
        function checkCacheManager() {
            const statusElement = document.getElementById('cache-manager-status');

            if (window.cacheManager) {
                statusElement.className = 'status-display status-success';
                statusElement.textContent = 'âœ… ç¼“å­˜ç®¡ç†å™¨å·²åˆå§‹åŒ–';
                addLog('ç¼“å­˜ç®¡ç†å™¨çŠ¶æ€: å·²æ­£ç¡®åˆå§‹åŒ–', 'success');
            } else {
                statusElement.className = 'status-display status-error';
                statusElement.textContent = 'âŒ ç¼“å­˜ç®¡ç†å™¨æœªæ‰¾åˆ°';
                addLog('ç¼“å­˜ç®¡ç†å™¨çŠ¶æ€: æœªæ‰¾åˆ°æˆ–åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        // æ•°æ®ä¿å­˜æµ‹è¯•
        function testDataSave() {
            const resultElement = document.getElementById('save-load-result');

            try {
                const testData = {
                    timestamp: Date.now(),
                    content: 'è¿™æ˜¯æµ‹è¯•æ•°æ®',
                    array: [1, 2, 3, 4, 5],
                    nested: { key: 'value', number: 42 }
                };

                if (window.cacheManager) {
                    const success = window.cacheManager.set('test_data', testData);
                    if (success) {
                        resultElement.className = 'status-display status-success';
                        resultElement.textContent = 'âœ… æ•°æ®ä¿å­˜æˆåŠŸ';
                        addLog('æ•°æ®ä¿å­˜æµ‹è¯•: æˆåŠŸä¿å­˜æµ‹è¯•æ•°æ®', 'success');
                    } else {
                        throw new Error('ç¼“å­˜ç®¡ç†å™¨ä¿å­˜å¤±è´¥');
                    }
                } else {
                    localStorage.setItem('test_data', JSON.stringify(testData));
                    resultElement.className = 'status-display status-success';
                    resultElement.textContent = 'âœ… ä½¿ç”¨localStorageä¿å­˜æˆåŠŸ';
                    addLog('æ•°æ®ä¿å­˜æµ‹è¯•: ä½¿ç”¨localStorageä¿å­˜æˆåŠŸ', 'success');
                }
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ ä¿å­˜å¤±è´¥: ${error.message}`;
                addLog(`æ•°æ®ä¿å­˜æµ‹è¯•: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // æ•°æ®åŠ è½½æµ‹è¯•
        function testDataLoad() {
            const resultElement = document.getElementById('save-load-result');

            try {
                let loadedData;

                if (window.cacheManager) {
                    loadedData = window.cacheManager.get('test_data');
                } else {
                    const data = localStorage.getItem('test_data');
                    loadedData = data ? JSON.parse(data) : null;
                }

                if (loadedData && loadedData.content === 'è¿™æ˜¯æµ‹è¯•æ•°æ®') {
                    resultElement.className = 'status-display status-success';
                    resultElement.textContent = 'âœ… æ•°æ®åŠ è½½æˆåŠŸï¼Œå†…å®¹éªŒè¯é€šè¿‡';
                    addLog('æ•°æ®åŠ è½½æµ‹è¯•: æˆåŠŸåŠ è½½å¹¶éªŒè¯æµ‹è¯•æ•°æ®', 'success');
                } else if (loadedData) {
                    resultElement.className = 'status-display status-error';
                    resultElement.textContent = 'âŒ æ•°æ®åŠ è½½æˆåŠŸï¼Œä½†å†…å®¹éªŒè¯å¤±è´¥';
                    addLog('æ•°æ®åŠ è½½æµ‹è¯•: åŠ è½½æˆåŠŸä½†æ•°æ®éªŒè¯å¤±è´¥', 'error');
                } else {
                    resultElement.className = 'status-display status-error';
                    resultElement.textContent = 'âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ•°æ®';
                    addLog('æ•°æ®åŠ è½½æµ‹è¯•: æœªæ‰¾åˆ°æµ‹è¯•æ•°æ®', 'error');
                }
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
                addLog(`æ•°æ®åŠ è½½æµ‹è¯•: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // å¤‡ä»½åˆ›å»ºæµ‹è¯•
        function testBackupCreate() {
            const resultElement = document.getElementById('backup-result');

            try {
                if (window.cacheManager) {
                    const backupKey = window.cacheManager.createBackup();
                    if (backupKey) {
                        resultElement.className = 'status-display status-success';
                        resultElement.textContent = `âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ: ${backupKey}`;
                        addLog(`å¤‡ä»½åˆ›å»ºæµ‹è¯•: æˆåŠŸåˆ›å»ºå¤‡ä»½ ${backupKey}`, 'success');
                    } else {
                        throw new Error('å¤‡ä»½åˆ›å»ºå¤±è´¥');
                    }
                } else {
                    throw new Error('ç¼“å­˜ç®¡ç†å™¨ä¸å¯ç”¨');
                }
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ å¤‡ä»½åˆ›å»ºå¤±è´¥: ${error.message}`;
                addLog(`å¤‡ä»½åˆ›å»ºæµ‹è¯•: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // å¤‡ä»½æ¢å¤æµ‹è¯•
        function testBackupRestore() {
            const resultElement = document.getElementById('backup-result');

            try {
                if (window.cacheManager) {
                    // æŸ¥æ‰¾æœ€æ–°å¤‡ä»½
                    const backupKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('wechat_backup_')) {
                            backupKeys.push(key);
                        }
                    }

                    if (backupKeys.length > 0) {
                        backupKeys.sort().reverse(); // æœ€æ–°çš„åœ¨å‰
                        const latestBackup = backupKeys[0];
                        const success = window.cacheManager.restoreBackup(latestBackup);

                        if (success) {
                            resultElement.className = 'status-display status-success';
                            resultElement.textContent = `âœ… å¤‡ä»½æ¢å¤æˆåŠŸ: ${latestBackup}`;
                            addLog(`å¤‡ä»½æ¢å¤æµ‹è¯•: æˆåŠŸæ¢å¤å¤‡ä»½ ${latestBackup}`, 'success');
                        } else {
                            throw new Error('å¤‡ä»½æ¢å¤å¤±è´¥');
                        }
                    } else {
                        throw new Error('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„å¤‡ä»½');
                    }
                } else {
                    throw new Error('ç¼“å­˜ç®¡ç†å™¨ä¸å¯ç”¨');
                }
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ å¤‡ä»½æ¢å¤å¤±è´¥: ${error.message}`;
                addLog(`å¤‡ä»½æ¢å¤æµ‹è¯•: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // æ•°æ®å¯¼å‡ºæµ‹è¯•
        function testDataExport() {
            const resultElement = document.getElementById('export-import-result');

            try {
                if (window.cacheManager) {
                    window.cacheManager.exportData();
                    resultElement.className = 'status-display status-success';
                    resultElement.textContent = 'âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼Œè¯·æ£€æŸ¥ä¸‹è½½æ–‡ä»¶';
                    addLog('æ•°æ®å¯¼å‡ºæµ‹è¯•: æˆåŠŸè§¦å‘æ•°æ®å¯¼å‡º', 'success');
                } else {
                    throw new Error('ç¼“å­˜ç®¡ç†å™¨ä¸å¯ç”¨');
                }
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ æ•°æ®å¯¼å‡ºå¤±è´¥: ${error.message}`;
                addLog(`æ•°æ®å¯¼å‡ºæµ‹è¯•: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // æ•°æ®å¯¼å…¥æµ‹è¯•
        function testDataImport(input) {
            const resultElement = document.getElementById('export-import-result');
            const file = input.files[0];

            if (!file) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = 'âŒ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶';
                addLog('æ•°æ®å¯¼å…¥æµ‹è¯•: æ²¡æœ‰é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            try {
                if (window.cacheManager) {
                    window.cacheManager.importData(file).then(() => {
                        resultElement.className = 'status-display status-success';
                        resultElement.textContent = 'âœ… æ•°æ®å¯¼å…¥æˆåŠŸ';
                        addLog('æ•°æ®å¯¼å…¥æµ‹è¯•: æˆåŠŸå¯¼å…¥æ•°æ®æ–‡ä»¶', 'success');
                    }).catch((error) => {
                        resultElement.className = 'status-display status-error';
                        resultElement.textContent = `âŒ æ•°æ®å¯¼å…¥å¤±è´¥: ${error.message}`;
                        addLog(`æ•°æ®å¯¼å…¥æµ‹è¯•: å¤±è´¥ - ${error.message}`, 'error');
                    });
                } else {
                    throw new Error('ç¼“å­˜ç®¡ç†å™¨ä¸å¯ç”¨');
                }
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ æ•°æ®å¯¼å…¥å¤±è´¥: ${error.message}`;
                addLog(`æ•°æ®å¯¼å…¥æµ‹è¯•: å¤±è´¥ - ${error.message}`, 'error');
            }

            input.value = ''; // æ¸…ç©ºè¾“å…¥
        }

        // æ¨¡æ‹Ÿå¼‚å¸¸é€€å‡º
        function simulateAbnormalExit() {
            const resultElement = document.getElementById('exit-simulation-result');

            try {
                if (window.cacheManager) {
                    window.cacheManager.setNormalExit(false);
                    resultElement.className = 'status-display status-success';
                    resultElement.textContent = 'âœ… å·²æ¨¡æ‹Ÿå¼‚å¸¸é€€å‡ºæ ‡è®°';
                    addLog('å¼‚å¸¸é€€å‡ºæ¨¡æ‹Ÿ: æˆåŠŸè®¾ç½®å¼‚å¸¸é€€å‡ºæ ‡è®°', 'success');
                } else {
                    throw new Error('ç¼“å­˜ç®¡ç†å™¨ä¸å¯ç”¨');
                }
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`;
                addLog(`å¼‚å¸¸é€€å‡ºæ¨¡æ‹Ÿ: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // æ¨¡æ‹Ÿæ­£å¸¸é€€å‡º
        function simulateNormalExit() {
            const resultElement = document.getElementById('exit-simulation-result');

            try {
                if (window.cacheManager) {
                    window.cacheManager.setNormalExit(true);
                    resultElement.className = 'status-display status-success';
                    resultElement.textContent = 'âœ… å·²æ¨¡æ‹Ÿæ­£å¸¸é€€å‡ºæ ‡è®°';
                    addLog('æ­£å¸¸é€€å‡ºæ¨¡æ‹Ÿ: æˆåŠŸè®¾ç½®æ­£å¸¸é€€å‡ºæ ‡è®°', 'success');
                } else {
                    throw new Error('ç¼“å­˜ç®¡ç†å™¨ä¸å¯ç”¨');
                }
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`;
                addLog(`æ­£å¸¸é€€å‡ºæ¨¡æ‹Ÿ: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ®
        function generateLargeDataset() {
            const resultElement = document.getElementById('large-data-result');

            try {
                const largeData = {
                    users: [],
                    dialogs: [],
                    settings: {}
                };

                // ç”Ÿæˆç”¨æˆ·æ•°æ®
                for (let i = 0; i < 100; i++) {
                    largeData.users.push({
                        id: i,
                        name: `æµ‹è¯•ç”¨æˆ·${i}`,
                        avatar: `test_avatar_${i}.png`,
                        created: Date.now() + i
                    });
                }

                // ç”Ÿæˆå¯¹è¯æ•°æ®
                for (let i = 0; i < 1000; i++) {
                    largeData.dialogs.push({
                        id: i,
                        userId: Math.floor(Math.random() * 100),
                        message: `è¿™æ˜¯ç¬¬${i}æ¡æµ‹è¯•æ¶ˆæ¯ï¼ŒåŒ…å«è¶³å¤Ÿçš„å†…å®¹æ¥æµ‹è¯•å­˜å‚¨èƒ½åŠ›`,
                        timestamp: Date.now() + i,
                        type: 'text'
                    });
                }

                if (window.cacheManager) {
                    window.cacheManager.set('large_test_data', largeData);
                } else {
                    localStorage.setItem('large_test_data', JSON.stringify(largeData));
                }

                resultElement.className = 'status-display status-success';
                resultElement.textContent = 'âœ… å·²ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ® (100ç”¨æˆ· + 1000å¯¹è¯)';
                addLog('å¤§é‡æ•°æ®æµ‹è¯•: æˆåŠŸç”Ÿæˆ100ç”¨æˆ·å’Œ1000æ¡å¯¹è¯è®°å½•', 'success');
                updateStats();
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
                addLog(`å¤§é‡æ•°æ®æµ‹è¯•: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æµ‹è¯•æ•°æ®
        function clearTestData() {
            const resultElement = document.getElementById('large-data-result');

            try {
                localStorage.removeItem('large_test_data');
                localStorage.removeItem('test_data');

                resultElement.className = 'status-display status-success';
                resultElement.textContent = 'âœ… å·²æ¸…é™¤æµ‹è¯•æ•°æ®';
                addLog('æ¸…é™¤æµ‹è¯•æ•°æ®: æˆåŠŸæ¸…é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®', 'success');
                updateStats();
            } catch (error) {
                resultElement.className = 'status-display status-error';
                resultElement.textContent = `âŒ æ¸…é™¤å¤±è´¥: ${error.message}`;
                addLog(`æ¸…é™¤æµ‹è¯•æ•°æ®: å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // å¼€å§‹æ€§èƒ½æµ‹è¯•
        function startPerformanceTest() {
            const resultElement = document.getElementById('performance-result');
            const progressElement = document.getElementById('performance-progress');

            if (performanceTestInterval) {
                clearInterval(performanceTestInterval);
            }

            let testCount = 0;
            const maxTests = 100;
            const startTime = Date.now();

            resultElement.className = 'status-display status-info';
            resultElement.textContent = 'ğŸ”„ æ€§èƒ½æµ‹è¯•è¿›è¡Œä¸­...';
            addLog('æ€§èƒ½æµ‹è¯•: å¼€å§‹è¿›è¡Œ100æ¬¡ä¿å­˜/åŠ è½½å¾ªç¯æµ‹è¯•', 'info');

            performanceTestInterval = setInterval(() => {
                try {
                    const testData = {
                        iteration: testCount,
                        timestamp: Date.now(),
                        randomData: Math.random().toString(36).repeat(100)
                    };

                    // ä¿å­˜æµ‹è¯•
                    if (window.cacheManager) {
                        window.cacheManager.set(`perf_test_${testCount}`, testData);
                        window.cacheManager.get(`perf_test_${testCount}`);
                    } else {
                        localStorage.setItem(`perf_test_${testCount}`, JSON.stringify(testData));
                        JSON.parse(localStorage.getItem(`perf_test_${testCount}`));
                    }

                    testCount++;
                    const progress = (testCount / maxTests) * 100;
                    progressElement.style.width = progress + '%';

                    if (testCount >= maxTests) {
                        clearInterval(performanceTestInterval);
                        const duration = Date.now() - startTime;
                        resultElement.className = 'status-display status-success';
                        resultElement.textContent = `âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ: ${maxTests}æ¬¡æ“ä½œç”¨æ—¶ ${duration}ms`;
                        addLog(`æ€§èƒ½æµ‹è¯•: å®Œæˆ100æ¬¡æ“ä½œï¼Œæ€»ç”¨æ—¶${duration}msï¼Œå¹³å‡${(duration / maxTests).toFixed(2)}ms/æ¬¡`, 'success');

                        // æ¸…ç†æ€§èƒ½æµ‹è¯•æ•°æ®
                        for (let i = 0; i < maxTests; i++) {
                            localStorage.removeItem(`perf_test_${i}`);
                        }
                    }
                } catch (error) {
                    clearInterval(performanceTestInterval);
                    resultElement.className = 'status-display status-error';
                    resultElement.textContent = `âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥: ${error.message}`;
                    addLog(`æ€§èƒ½æµ‹è¯•: åœ¨ç¬¬${testCount}æ¬¡æµ‹è¯•æ—¶å¤±è´¥ - ${error.message}`, 'error');
                }
            }, 10);
        }

        // åœæ­¢æ€§èƒ½æµ‹è¯•
        function stopPerformanceTest() {
            if (performanceTestInterval) {
                clearInterval(performanceTestInterval);
                performanceTestInterval = null;

                const resultElement = document.getElementById('performance-result');
                const progressElement = document.getElementById('performance-progress');

                resultElement.className = 'status-display status-warning';
                resultElement.textContent = 'âš ï¸ æ€§èƒ½æµ‹è¯•å·²æ‰‹åŠ¨åœæ­¢';
                progressElement.style.width = '0%';
                addLog('æ€§èƒ½æµ‹è¯•: ç”¨æˆ·æ‰‹åŠ¨åœæ­¢æµ‹è¯•', 'warning');
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            try {
                // è®¡ç®—å­˜å‚¨ä½¿ç”¨é‡
                let totalSize = 0;
                let keyCount = 0;
                let backupCount = 0;

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    totalSize += key.length + value.length;
                    keyCount++;

                    if (key.startsWith('wechat_backup_')) {
                        backupCount++;
                    }
                }

                document.getElementById('stat-storage-used').textContent = (totalSize / 1024).toFixed(1) + ' KB';
                document.getElementById('stat-keys-count').textContent = keyCount;
                document.getElementById('stat-backup-count').textContent = backupCount;

                // è·å–æœ€åä¿å­˜æ—¶é—´
                if (window.cacheManager) {
                    const stats = window.cacheManager.getCacheStats();
                    document.getElementById('stat-last-save').textContent = stats.lastSave || 'æœªçŸ¥';
                } else {
                    document.getElementById('stat-last-save').textContent = 'æœªçŸ¥';
                }

                addLog(`ç»Ÿè®¡ä¿¡æ¯æ›´æ–°: ${keyCount}ä¸ªé”®ï¼Œä½¿ç”¨${(totalSize / 1024).toFixed(1)}KBï¼Œ${backupCount}ä¸ªå¤‡ä»½`, 'info');
            } catch (error) {
                addLog(`ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š
        function exportTestReport() {
            try {
                const report = {
                    testDate: new Date().toISOString(),
                    browserInfo: getBrowserInfo(),
                    testResults: testLog,
                    statistics: {
                        storageUsed: document.getElementById('stat-storage-used').textContent,
                        keyCount: document.getElementById('stat-keys-count').textContent,
                        backupCount: document.getElementById('stat-backup-count').textContent,
                        lastSave: document.getElementById('stat-last-save').textContent
                    }
                };

                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ç¼“å­˜åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                addLog('æµ‹è¯•æŠ¥å‘Š: æˆåŠŸå¯¼å‡ºæµ‹è¯•æŠ¥å‘Š', 'success');
            } catch (error) {
                addLog(`æµ‹è¯•æŠ¥å‘Šå¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®
        function clearAllTestData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                try {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('test_') || key.startsWith('large_test_') || key.startsWith('perf_test_'))) {
                            keysToRemove.push(key);
                        }
                    }

                    keysToRemove.forEach(key => localStorage.removeItem(key));

                    addLog(`æ¸…ç©ºæµ‹è¯•æ•°æ®: æˆåŠŸæ¸…é™¤${keysToRemove.length}ä¸ªæµ‹è¯•æ•°æ®é¡¹`, 'success');
                    updateStats();
                } catch (error) {
                    addLog(`æ¸…ç©ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            testLog = [];
            document.getElementById('log-container').innerHTML = '';
            addLog('æ—¥å¿—ç³»ç»Ÿ: æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLog() {
            try {
                const logData = {
                    exportTime: new Date().toISOString(),
                    logs: testLog
                };

                const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æµ‹è¯•æ—¥å¿—_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                addLog('æ—¥å¿—ç³»ç»Ÿ: æˆåŠŸå¯¼å‡ºæµ‹è¯•æ—¥å¿—', 'success');
            } catch (error) {
                addLog(`æ—¥å¿—å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            addLog(`æ—¥å¿—ç³»ç»Ÿ: è‡ªåŠ¨æ»šåŠ¨å·²${autoScroll ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'info');
        }

        // è·å–æµè§ˆå™¨ä¿¡æ¯
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            let browserName = "Unknown";
            let browserVersion = "Unknown";
            let isSupported = false;

            if (ua.indexOf("Chrome") > -1) {
                browserName = "Chrome";
                browserVersion = ua.match(/Chrome\/([0-9.]+)/)?.[1] || "Unknown";
                isSupported = true;
            } else if (ua.indexOf("Firefox") > -1) {
                browserName = "Firefox";
                browserVersion = ua.match(/Firefox\/([0-9.]+)/)?.[1] || "Unknown";
                isSupported = true;
            } else if (ua.indexOf("Safari") > -1) {
                browserName = "Safari";
                browserVersion = ua.match(/Version\/([0-9.]+)/)?.[1] || "Unknown";
                isSupported = true;
            } else if (ua.indexOf("Edge") > -1) {
                browserName = "Edge";
                browserVersion = ua.match(/Edge\/([0-9.]+)/)?.[1] || "Unknown";
                isSupported = true;
            }

            return { name: browserName, version: browserVersion, isSupported };
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            addLog('æµ‹è¯•ç³»ç»Ÿ: ç¼“å­˜åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');

            // ç­‰å¾…ç¼“å­˜ç®¡ç†å™¨åŠ è½½
            setTimeout(() => {
                checkBrowserSupport();
                checkStorageSupport();
                checkCacheManager();
                updateStats();

                // å®šæœŸæ›´æ–°ç»Ÿè®¡
                setInterval(updateStats, 30000);

                addLog('æµ‹è¯•ç³»ç»Ÿ: åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
            }, 1000);
        });
    </script>
</body>

</html>